#!/usr/bin/env bash

SCRIPT_NAME="$0"

declare -a TARGET_NODES=()

OUTPUT_VIRSH_LIST=

REGEX_DOMAIN='dev\-(controller|compute|cinder|storage)[0-9]+'

log_info() {
    echo "$(date) - INFO: $1"
}
log_err() {
    echo "$(date) - ERROR: $1" >&2
}

main() {
    local sub_command="$1"
    local arg="$2"

    if [ -z "$sub_command" ]; then
        usage
        return 0
    fi

    init_target_nodes || return 1

    #if [[ "${sub_command}" =~ ^(start|destroy|snapshot-list|snapshot-create-as|snapshot-delete)$ ]]; then
    if [ "${sub_command}" = "start" -o "${sub_command}" = "destroy" ]; then
        execute_start_stop "${sub_command}"
    elif [ "${sub_command}" = "list" ]; then
        list_domain "${sub_command}"
    elif [ "${sub_command}" = "snapshot-create-as" -o "${sub_command}" = "snapshot-delete" ]; then
        execute_snapshot "${sub_command}" "${arg}"
    elif [ "${sub_command}" = "snapshot-list" ]; then
        list_snapshot "${sub_command}"
    else
        log_err "Unknown sub command for virsh (sub_command=${sub_command})."
        return 1
    fi
}

execute_start_stop() {
    local sub_command="$1"

    for instance in ${TARGET_NODES[@]}; do
        log_info "Running a command: virsh ${sub_command} ${instance}"
        virsh "${sub_command}" ${instance}
    done
}

list_domain() {
    head -n 2 <<< "${OUTPUT_VIRSH_LIST}"
    grep -P "${REGEX_DOMAIN}" <<< "${OUTPUT_VIRSH_LIST}"
}

execute_snapshot() {
    local sub_command="$1"
    local arg="$2"

    for instance in ${TARGET_NODES[@]}; do
        log_info "Running a command: virsh ${sub_command} ${instance} ${arg} "
        virsh "${sub_command}" ${instance} ${arg} 
    done
}

list_snapshot() {
    local sub_command="$1"

    log_info "Running a command: virsh ${sub_command} --tree ${TARGET_NODES[0]}"
    virsh "${sub_command}" --tree ${TARGET_NODES[0]}
}

usage() {
    cat << EOF
This is a script for KVM instances that are used for OpenStack dev environment.
This script will execute command to all of them at all once for example start, stop(destroy), snapshot-create-as or snapshot-delete etc.

ex)
  ${SCRIPT_NAME} start
  ${SCRIPT_NAME} destroy
  ${SCRIPT_NAME} list
  ${SCRIPT_NAME} snapshot-list    # It will list snapshot only in a controller node on behalf of all other nodes.
  ${SCRIPT_NAME} snapshot-create-as \${snapshot_name}
  ${SCRIPT_NAME} snapshot-delete \${snapshot_name}
EOF
}

init_target_nodes() {
    OUTPUT_VIRSH_LIST="$(virsh list --all)"
    IFS=$'\n' TARGET_NODES=($(echo "${OUTPUT_VIRSH_LIST}" | tail -n +3 | awk '{print $2}' | grep -P "${REGEX_DOMAIN}"))

    [ ${#TARGET_NODES[@]} -eq 0 ] && {
        log_err "There are no VM nodes to execute a command, dev-controllerXX, dev-computesXX or dev-storageXX etc."
        return 1
    }
    return 0
}

main "$@"
